<!DOCTYPE html>  <html> <head>   <title>watchr.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="bin.html">                 bin.coffee               </a>                                           <a class="source" href="watchr.html">                 watchr.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               watchr.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Watchr</span> <span class="o">is</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">nofitied</span> <span class="k">when</span> <span class="nx">a</span> <span class="nx">change</span> <span class="nx">happens</span> <span class="nx">to</span><span class="p">,</span> <span class="o">or</span> <span class="nx">within</span> <span class="nx">a</span> <span class="nx">directory</span><span class="p">.</span>
<span class="nx">You</span> <span class="nx">will</span> <span class="o">not</span> <span class="nx">be</span> <span class="nx">notified</span> <span class="nx">what</span> <span class="nx">file</span> <span class="nx">was</span> <span class="nx">changed</span><span class="p">,</span> <span class="o">or</span> <span class="nx">how</span> <span class="nx">it</span> <span class="nx">was</span> <span class="nx">changed</span><span class="p">.</span>
<span class="nx">It</span> <span class="nx">will</span> <span class="nx">track</span> <span class="k">new</span> <span class="nx">files</span> <span class="o">and</span> <span class="nx">their</span> <span class="nx">changes</span> <span class="nx">too</span><span class="p">,</span> <span class="o">and</span> <span class="nx">remove</span> <span class="nx">listeners</span> <span class="k">for</span> <span class="nx">deleted</span> <span class="nx">files</span> <span class="nx">appropriatly</span><span class="p">.</span>

<span class="nx">The</span> <span class="nx">source</span> <span class="nx">code</span> <span class="nx">here</span> <span class="o">is</span> <span class="nx">written</span> <span class="nx">as</span> <span class="nx">an</span> <span class="nx">experiment</span> <span class="k">of</span> <span class="nx">literate</span> <span class="nx">programming</span>
<span class="nx">Which</span> <span class="nx">means</span> <span class="nx">you</span> <span class="nx">would</span> <span class="nx">be</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">understand</span> <span class="nx">it</span><span class="p">,</span> <span class="nx">without</span> <span class="nx">knowing</span> <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Require the node.js file system module
This provides us with what we need to interact with the file system (aka files and directories)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Require the node.js event emitter
This provides us with the event system that we use for binding and trigger events</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Require the balUtil module
This provides us with various flow logic and path utilities</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">balUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bal-util&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Let's set the debugging mode
We will use this later on when outputting messages that make our code easier to debug
Note: when we publish the module, we want to set this as off, as we don't want the application using us
 to spurt our all our debug messages!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">debug = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Now to make watching files more convient and managed, we'll create a class which we can use to attach to each file
It'll provide us with the API and abstraction we need to accomplish difficult things like recursion
We'll also store a global store of all the watchers and their paths so we don't have multiple watchers going at the same time
 for the same file - as that would be quite ineffecient</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">watchers = </span><span class="p">{}</span>
<span class="nv">Watcher = </span><span class="k">class</span> <span class="k">extends</span> <span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The path this class instance is attached to</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">path: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Is it a directory or not?</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">isDirectory: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Our fs.stat object, it contains things like change times, size, and is it a directory</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">stat: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The node.js file watcher instance, we have to open and close this, it is what notifies us of the events</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">fswatcher: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The watchers for the children of this watcher will go here
This is for when we are watching a directory, we will scan the directory and children go here</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">children: </span><span class="kc">null</span>  <span class="c1"># {}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We have to store the current state of the watcher and it is asynchronous (things can fire in any order)
as such, we don't want to be doing particular things if this watcher is deactivated (closed)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">state: </span><span class="s1">&#39;pending&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>The method we will use to watch the files
Preferably we use watchFile, however we may need to use watch in case watchFile doesn't exist (e.g. windows)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">method: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Now it's time to construct our watcher
We give it a path, and give it some events to use
Then we get to work with watching it
next()</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">constructor: </span><span class="nf">(options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">options</span> <span class="o">or=</span> <span class="p">{}</span>
		<span class="nv">watcher = </span><span class="err">@</span>
		<span class="vi">@children = </span><span class="p">{}</span>
		<span class="nv">applyStat = </span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="vi">@stat = </span><span class="nx">stat</span>
			<span class="vi">@isDirectory = </span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span>
			<span class="nx">@watch</span> <span class="nf">(err) -&gt;</span>
				<span class="nx">options</span><span class="p">.</span><span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">watcher</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Path</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@path = </span><span class="nx">options</span><span class="p">.</span><span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Options</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@options = </span><span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Event</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">listener</span>
			<span class="nx">@listen</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">listener</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">listeners</span>
			<span class="k">for</span> <span class="nx">listener</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">listeners</span>
				<span class="nx">@listen</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Stat</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">stat</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>We already have a stat</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">applyStat</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">stat</span><span class="p">)</span>
		<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Fetch a stat</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">@path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">stat</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Check if we are no longer necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
					<span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Check if an error occured</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">err</span>
					<span class="k">throw</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Apply the stat</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">applyStat</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Before we start watching, we'll have to setup the functions our watcher will need</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Listen to the change event for us</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">listen: </span><span class="nf">(listener) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Listen</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@removeListener</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span><span class="nx">listener</span><span class="p">)</span>
		<span class="nx">@on</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span><span class="nx">listener</span><span class="p">)</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;added a listener: on #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>We need something to bubble events up from a child file all the way up the top</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">bubble: </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">[</span><span class="nx">eventName</span><span class="p">,</span><span class="nx">filename</span><span class="p">,</span><span class="nx">currentStat</span><span class="p">,</span><span class="nx">previousStat</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Log</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;bubble: #{eventName}: #{filename} on #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Trigger</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@emit</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span><span class="nx">eventName</span><span class="p">,</span><span class="nx">filename</span><span class="p">,</span><span class="nx">currentStat</span><span class="p">,</span><span class="nx">previousStat</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>A change event has fired
Things to note:
watchFile:
    currentStat still exists even for deleted/renamed files
    for deleted and changed files, it will fire on the file
    for new files, it will fire on the directory
fsWatcher:
    eventName is always 'change', 'rename' is not yet implemented by node
    currentStat still exists even for deleted/renamed files
    previousStat is accurate, however we already have htis
    for deleted and changed files, it will fire on the file
    for new files, it will fire on the directory
How this should work:
for changed files: 'change', fullPath, currentStat, previousStat
for new files:     'new',    fullPath, currentStat, null
for deleted files: 'unlink', fullPath, null,        previousStat
In the future we will add:
for renamed files: 'rename', fullPath, currentStat, previousStat, newFullPath
rename is possible as the stat.ino is the same for the unlink and new</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">changed: </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">me = </span><span class="err">@</span>
		<span class="nv">fileFullPath = </span><span class="nx">@path</span>
		<span class="nv">currentStat = </span><span class="kc">null</span>
		<span class="nv">previousStat = </span><span class="nx">@stat</span>
		<span class="nv">fileExists = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Log</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;watch event triggered on #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>console.log args  if debug</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Prepare: is the same?</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">isTheSame = </span><span class="o">=&gt;</span>
			<span class="k">if</span> <span class="nx">currentStat</span><span class="o">?</span> <span class="o">and</span> <span class="nx">previousStat</span><span class="o">?</span>
				<span class="k">if</span> <span class="nx">currentStat</span><span class="p">.</span><span class="nx">size</span> <span class="o">is</span> <span class="nx">previousStat</span><span class="p">.</span><span class="nx">size</span> <span class="o">and</span> <span class="nx">currentStat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="nx">previousStat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
					<span class="k">return</span> <span class="kc">true</span>
			<span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Prepare: determine the change</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">determineTheChange = </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If we no longer exist, then we where deleted</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="o">!</span><span class="nx">fileExists</span>
				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;determined unlink:&#39;</span><span class="p">,</span><span class="nx">fileFullPath</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">debug</span>
				<span class="nx">@emit</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span><span class="s1">&#39;unlink&#39;</span><span class="p">,</span><span class="nx">fileFullPath</span><span class="p">,</span><span class="nx">currentStat</span><span class="p">,</span><span class="nx">previousStat</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Otherwise, we still do exist</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Let's check for changes</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">isTheSame</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>nothing has changed, so ignore</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;determined same:&quot;</span><span class="p">,</span><span class="nx">fileFullPath</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Otherwise, something has changed</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>So let's check if we are a directory
as if we are a directory the chances are something actually happened to a child (rename or delete)
and if we are the same, then we should scan our children to look for renames and deletes</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="nx">@isDirectory</span>
						<span class="k">if</span> <span class="nx">isTheSame</span><span class="p">()</span> <span class="o">is</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Check for new files</p>             </td>             <td class="code">               <div class="highlight"><pre>							<span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">fileFullPath</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">newFileRelativePaths</span><span class="p">)</span> <span class="o">=&gt;</span>
								<span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
								<span class="nx">balUtil</span><span class="p">.</span><span class="nx">each</span> <span class="nx">newFileRelativePaths</span><span class="p">,</span> <span class="p">(</span><span class="nx">newFileRelativePath</span><span class="p">)</span> <span class="o">=&gt;</span>
									<span class="k">if</span> <span class="nx">@children</span><span class="p">[</span><span class="nx">newFileRelativePath</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>already exists</p>             </td>             <td class="code">               <div class="highlight"><pre>									<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>new file</p>             </td>             <td class="code">               <div class="highlight"><pre>										<span class="nv">newFileFullPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fileFullPath</span><span class="p">,</span><span class="nx">newFileRelativePath</span><span class="p">)</span>
										<span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">newFileFullPath</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">newFileStat</span><span class="p">)</span> <span class="o">=&gt;</span>
											<span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
											<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;determined new:&#39;</span><span class="p">,</span><span class="nx">newFileFullPath</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">debug</span>
											<span class="nx">@emit</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span><span class="s1">&#39;new&#39;</span><span class="p">,</span><span class="nx">newFileFullPath</span><span class="p">,</span><span class="nx">newFileStat</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span>
											<span class="nx">@watchChild</span><span class="p">(</span><span class="nx">newFileFullPath</span><span class="p">,</span><span class="nx">newFileRelativePath</span><span class="p">,</span><span class="nx">newFileStat</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>If we are a file, lets simply emit the change event</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>It has changed, so let's emit a change event</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;determined change:&#39;</span><span class="p">,</span><span class="nx">fileFullPath</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">debug</span>
						<span class="nx">@emit</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">,</span><span class="nx">fileFullPath</span><span class="p">,</span><span class="nx">currentStat</span><span class="p">,</span><span class="nx">previousStat</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Check if the file still exists</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">fileFullPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Apply</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">fileExists = </span><span class="nx">exists</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>If the file still exists, then update the stat</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">fileExists</span>
				<span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">fileFullPath</span><span class="p">,</span> <span class="nf">(err,stat) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Check</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Update</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">currentStat = </span><span class="nx">stat</span>
					<span class="nv">me.stat = </span><span class="nx">currentStat</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Get on with it</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">determineTheChange</span><span class="p">()</span>
			<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Get on with it</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">determineTheChange</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>We will need something to close our listener for removed or renamed files
As renamed files are a bit difficult we will want to close and delete all the watchers for all our children too
Essentially it is like a self-destruct without the body parts</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">close: </span><span class="o">-&gt;</span>
		<span class="k">return</span> <span class="err">@</span>  <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;close: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Close our children</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">own</span> <span class="nx">childRelativePath</span><span class="p">,</span><span class="nx">watchr</span> <span class="k">of</span> <span class="nx">@children</span>
			<span class="nx">@closeChild</span><span class="p">(</span><span class="nx">childRelativePath</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Close ourself</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@state</span> <span class="o">isnt</span> <span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Close listener</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@method</span> <span class="o">is</span> <span class="s1">&#39;watchFile&#39;</span>
				<span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span>
			<span class="k">else</span> <span class="k">if</span> <span class="nx">@method</span> <span class="o">is</span> <span class="s1">&#39;watch&#39;</span>  <span class="o">and</span>  <span class="nx">@fswatcher</span>
				<span class="nx">@fswatcher</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
				<span class="vi">@fswatcher = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Updated state</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="vi">@state = </span><span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Delete our watchers reference</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">delete</span> <span class="nx">watchers</span><span class="p">[</span><span class="nx">@path</span><span class="p">]</span>  <span class="k">if</span> <span class="nx">watchers</span><span class="p">[</span><span class="nx">@path</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Close a child</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">closeChild: </span><span class="nf">(fileRelativePath) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">watcher = </span><span class="nx">@children</span><span class="p">[</span><span class="nx">fileRelativePath</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Check</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">watcher</span>
			<span class="nx">watcher</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
			<span class="k">delete</span> <span class="nx">@children</span><span class="p">[</span><span class="nx">fileRelativePath</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Setup watching a child</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">watchChild: </span><span class="nf">(fileFullPath,fileRelativePath,fileStat,next) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">me = </span><span class="err">@</span>
		<span class="nv">options = </span><span class="nx">@options</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Watch the file</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">watch</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">path: </span><span class="nx">fileFullPath</span>
			<span class="nv">listener: </span><span class="nf">(args...) -&gt;</span>
				<span class="nx">me</span><span class="p">.</span><span class="nx">bubble</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Options</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">stat: </span><span class="nx">fileStat</span>
			<span class="nv">ignoreHiddenFiles: </span><span class="nx">options</span><span class="p">.</span><span class="nx">ignoreHiddenFiles</span>
			<span class="nv">ignorePatterns: </span><span class="nx">options</span><span class="p">.</span><span class="nx">ignorePatterns</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Next</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">next: </span><span class="nf">(err,watcher) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Stop if an error happened</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Store the child watchr in us</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">fileRelativePath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">watcher</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Proceed to the next file</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">next</span><span class="o">?</span><span class="p">()</span>
		<span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Setup the watching for our path
If we are already watching this path then let's start again (call close)
Then if we are a directory, let's recurse
Finally, let's initialise our node.js watcher that'll let us know when things happen
and update our state to active
next(err)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">watch: </span><span class="nf">(next) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">me = </span><span class="err">@</span>
		<span class="nv">options = </span><span class="nx">@options</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;watch: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Close our all watch listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@close</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Prepare Start Watching</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">startWatching = </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Create a set of tasks</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
				<span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="nv">tasks.total = </span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Cycle through the directory if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@isDirectory</span>
				<span class="nx">balUtil</span><span class="p">.</span><span class="nx">scandir</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Path</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">path: </span><span class="nx">@path</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Options</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">ignoreHiddenFiles: </span><span class="nx">options</span><span class="p">.</span><span class="nx">ignoreHiddenFiles</span>
					<span class="nv">ignorePatterns: </span><span class="nx">options</span><span class="p">.</span><span class="nx">ignorePatterns</span>
					<span class="nv">recurse: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Next</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">next: </span><span class="nf">(err) -&gt;</span>
						<span class="nx">tasks</span><span class="p">.</span><span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>File and Directory Actions</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">action: </span><span class="nf">(fileFullPath,fileRelativePath,nextFile,fileStat) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Watch it</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nx">me</span><span class="p">.</span><span class="nx">watchChild</span> <span class="nx">fileFullPath</span><span class="p">,</span> <span class="nx">fileRelativePath</span><span class="p">,</span> <span class="nx">fileStat</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
							<span class="nx">nextFile</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="p">)</span>
			<span class="k">else</span>
				<span class="nx">tasks</span><span class="p">.</span><span class="nx">complete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Watch the current file/directory</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">try</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Try first with fs.watchFile</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span> <span class="nx">@path</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
					<span class="nx">me</span><span class="p">.</span><span class="nx">changed</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span><span class="nx">args</span><span class="p">)</span>
				<span class="vi">@method = </span><span class="s1">&#39;watchFile&#39;</span>
			<span class="k">catch</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Then try with fs.watch</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="vi">@fswatcher = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">watch</span> <span class="nx">@path</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
					<span class="nx">me</span><span class="p">.</span><span class="nx">changed</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span><span class="nx">args</span><span class="p">)</span>
				<span class="vi">@method = </span><span class="s1">&#39;watch&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>We are now watching so set the state as active</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="vi">@state = </span><span class="s1">&#39;active&#39;</span>
			<span class="nx">tasks</span><span class="p">.</span><span class="nx">complete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Check if we still exist</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">@path</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Check</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">unless</span> <span class="nx">exists</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>We don't exist anymore, move along</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">next</span><span class="p">()</span>
				<span class="k">return</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Start watching</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">startWatching</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Provide our interface to the applications that use watchr
This will create our new Watcher class for the path we want
 (or use an existing one, and add the events)
Watcher also uses this too</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">watch = </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Three arguments
[path,options,next]</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">argTwo = </span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="nv">options = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Single Event</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="k">typeof</span> <span class="nx">argTwo</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
			<span class="nv">options.listener = </span><span class="nx">argTwo</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Multiple Events</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">argTwo</span><span class="p">)</span>
			<span class="nv">options.listeners = </span><span class="nx">argTwo</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Options</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">argTwo</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
			<span class="nv">options = </span><span class="nx">argTwo</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Extract</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">options.path = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nv">options.next = </span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>One argument
[options]</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">else</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Extract</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">argOne = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">if</span> <span class="k">typeof</span> <span class="nx">argOne</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
			<span class="nv">options = </span><span class="nx">argOne</span>
		<span class="k">else</span>
			<span class="nv">options = </span><span class="p">{}</span>
			<span class="nv">options.path = </span><span class="nx">argOne</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Extract path</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">path = </span><span class="nx">options</span><span class="p">.</span><span class="nx">path</span>
	<span class="nv">next = </span><span class="nx">options</span><span class="p">.</span><span class="nx">next</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Check if we are already watching that path</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="nx">watchers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>We do, so let's use that one instead</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">watcher = </span><span class="nx">watchers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
		<span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">watcher</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">watcher</span>
	<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>We don't, so let's create a new one</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">watcher = </span><span class="k">new</span> <span class="nx">Watcher</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
		<span class="nx">watchers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">watcher</span>
		<span class="k">return</span> <span class="nx">watcher</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Now let's provide node.js with our public API
In other words, what the application that calls us has access to</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="p">{</span><span class="nx">watch</span><span class="p">,</span><span class="nx">Watcher</span><span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 